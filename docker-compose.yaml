version: '3.8'

# =================================================================
# Oracle APEX + ORDS Docker Setup (Simplified)
# Optimized for Coolify with Persistent Storage
# =================================================================

services:
  # =================================================================
  # Oracle Database XE with APEX
  # =================================================================
  oracle-db:
    image: container-registry.oracle.com/database/express:21.3.0-xe
    container_name: apex-db
    hostname: oracle-db
    restart: unless-stopped
    shm_size: 1g
    
    environment:
      ORACLE_PWD: "${ORACLE_PWD}"
      ORACLE_CHARACTERSET: "AL32UTF8"
    
    ports:
      - "${DB_PORT:-1521}:1521"
      - "${DB_EM_PORT:-5500}:5500"
    
    volumes:
      - ./data/oracle:/opt/oracle/oradata
      - ./scripts/startup:/opt/oracle/scripts/startup
      - ./scripts/setup:/opt/oracle/scripts/setup
    
    networks:
      - apex-network
    
    healthcheck:
      test: ["CMD", "sh", "-c", "echo exit | sqlplus -L / as sysdba"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s
    
    labels:
      - "coolify.managed=true"

  # =================================================================
  # ORDS (Using custom entrypoint for auto-configuration)
  # =================================================================
  ords:
    build:
      context: .
      dockerfile: Dockerfile.ords
    container_name: apex-ords
    hostname: ords
    restart: unless-stopped
    
    depends_on:
      oracle-db:
        condition: service_healthy
    
    environment:
      DB_HOSTNAME: "oracle-db"
      DB_PORT: "1521"
      DB_SERVICE: "XEPDB1"
      SYS_PASSWORD: "${ORACLE_PWD}"
      ORDS_PASSWORD: "${ORACLE_PWD}"
    
    ports:
      - "${ORDS_PORT:-8181}:8181"
    
    volumes:
      - ./data/ords:/etc/ords
      - ./data/apex/images:/ords/images
    
    networks:
      - apex-network
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/ords/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    
    labels:
      - "coolify.managed=true"
      - "traefik.enable=true"
      
      # HTTP Router
      - "traefik.http.routers.apex-http.rule=Host(`${APEX_DOMAIN:-apex.localhost}`)"
      - "traefik.http.routers.apex-http.entrypoints=http"
      - "traefik.http.routers.apex-http.service=apex-service"
      
      # HTTPS Router
      - "traefik.http.routers.apex-https.rule=Host(`${APEX_DOMAIN:-apex.localhost}`)"
      - "traefik.http.routers.apex-https.entrypoints=https"
      - "traefik.http.routers.apex-https.tls=true"
      - "traefik.http.routers.apex-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.apex-https.service=apex-service"
      
      # Service
      - "traefik.http.services.apex-service.loadbalancer.server.port=8181"
      - "traefik.http.services.apex-service.loadbalancer.healthcheck.path=/ords/"

networks:
  apex-network:
    driver: bridge
    name: apex-network
